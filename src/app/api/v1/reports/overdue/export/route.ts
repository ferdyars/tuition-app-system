import { NextRequest } from "next/server";
import * as XLSX from "xlsx";
import { prisma } from "@/lib/prisma";
import { requireAuth } from "@/lib/api-auth";
import { getOverdueTuitions } from "@/lib/business-logic/overdue-calculator";
import { getMonthDisplayName } from "@/lib/business-logic/tuition-generator";

export async function GET(request: NextRequest) {
  const auth = await requireAuth(request);
  if (auth instanceof Response) return auth;

  const searchParams = request.nextUrl.searchParams;
  const classAcademicId = searchParams.get("classAcademicId") || undefined;
  const grade = searchParams.get("grade")
    ? Number(searchParams.get("grade"))
    : undefined;
  const academicYearId = searchParams.get("academicYearId") || undefined;

  // Get overdue items
  const overdueItems = await getOverdueTuitions(
    { classAcademicId, grade, academicYearId },
    prisma
  );

  // Get student details
  const studentNisList = [...new Set(overdueItems.map((i) => i.studentNis))];
  const students = await prisma.student.findMany({
    where: { nis: { in: studentNisList } },
    select: { nis: true, parentName: true },
  });
  const studentDetails = new Map(
    students.map((s) => [s.nis, { parentName: s.parentName }])
  );

  // Prepare Excel data
  const excelData = overdueItems.map((item) => ({
    "Student NIS": item.studentNis,
    "Student Name": item.studentName,
    "Parent Name": studentDetails.get(item.studentNis)?.parentName || "",
    "Parent Phone": item.parentPhone,
    Class: item.className,
    Grade: item.grade,
    Month: getMonthDisplayName(item.month),
    Year: item.year,
    "Fee Amount": item.feeAmount,
    "Paid Amount": item.paidAmount,
    "Outstanding": item.outstandingAmount,
    "Due Date": item.dueDate.toISOString().split("T")[0],
    "Days Overdue": item.daysOverdue,
  }));

  // Create workbook
  const workbook = XLSX.utils.book_new();
  const worksheet = XLSX.utils.json_to_sheet(excelData);

  // Set column widths
  worksheet["!cols"] = [
    { wch: 12 }, // NIS
    { wch: 25 }, // Student Name
    { wch: 25 }, // Parent Name
    { wch: 15 }, // Parent Phone
    { wch: 20 }, // Class
    { wch: 8 }, // Grade
    { wch: 12 }, // Month
    { wch: 8 }, // Year
    { wch: 15 }, // Fee Amount
    { wch: 15 }, // Paid Amount
    { wch: 15 }, // Outstanding
    { wch: 12 }, // Due Date
    { wch: 12 }, // Days Overdue
  ];

  XLSX.utils.book_append_sheet(workbook, worksheet, "Overdue Report");

  // Add summary sheet
  const summaryData = [
    { Metric: "Total Students with Overdue", Value: new Set(overdueItems.map((i) => i.studentNis)).size },
    { Metric: "Total Overdue Records", Value: overdueItems.length },
    {
      Metric: "Total Outstanding Amount",
      Value: overdueItems.reduce((sum, i) => sum + i.outstandingAmount, 0),
    },
    { Metric: "Report Generated", Value: new Date().toISOString() },
  ];
  const summarySheet = XLSX.utils.json_to_sheet(summaryData);
  summarySheet["!cols"] = [{ wch: 30 }, { wch: 20 }];
  XLSX.utils.book_append_sheet(workbook, summarySheet, "Summary");

  // Convert to buffer
  const buffer = XLSX.write(workbook, { type: "buffer", bookType: "xlsx" });

  const filename = `overdue-report-${new Date().toISOString().split("T")[0]}.xlsx`;

  return new Response(buffer, {
    headers: {
      "Content-Type":
        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      "Content-Disposition": `attachment; filename="${filename}"`,
    },
  });
}
