"use client";

import { Button, Stack, Textarea, TextInput } from "@mantine/core";
import { DatePickerInput } from "@mantine/dates";
import { useForm } from "@mantine/form";
import { useTranslations } from "next-intl";

interface StudentFormValues {
  nis: string;
  nik: string;
  name: string;
  address: string;
  parentName: string;
  parentPhone: string;
  startJoinDate: string | null;
}

interface StudentFormProps {
  initialData?: {
    nis?: string;
    nik?: string;
    name?: string;
    address?: string;
    parentName?: string;
    parentPhone?: string;
    startJoinDate?: string | Date;
  };
  onSubmit: (data: {
    nis: string;
    nik: string;
    name: string;
    address: string;
    parentName: string;
    parentPhone: string;
    startJoinDate: string;
  }) => void;
  isLoading?: boolean;
  isEdit?: boolean;
}

export default function StudentForm({
  initialData,
  onSubmit,
  isLoading,
  isEdit,
}: StudentFormProps) {
  const t = useTranslations();

  const form = useForm<StudentFormValues>({
    initialValues: {
      nis: initialData?.nis || "",
      nik: initialData?.nik || "",
      name: initialData?.name || "",
      address: initialData?.address || "",
      parentName: initialData?.parentName || "",
      parentPhone: initialData?.parentPhone || "",
      startJoinDate: initialData?.startJoinDate
        ? new Date(initialData.startJoinDate).toISOString()
        : null,
    },
    validate: {
      nis: (value) => (value.length < 1 ? t("student.nisRequired") : null),
      nik: (value) =>
        value.length !== 16 ? t("student.nikDigits") : null,
      name: (value) => (value.length < 1 ? t("student.nameRequired") : null),
      address: (value) =>
        value.length < 1 ? t("student.addressRequired") : null,
      parentName: (value) =>
        value.length < 1 ? t("student.parentNameRequired") : null,
      parentPhone: (value) =>
        value.length < 10 ? t("student.phoneMinDigits") : null,
      startJoinDate: (value) =>
        !value ? t("student.startDateRequired") : null,
    },
  });

  const handleSubmit = (values: StudentFormValues) => {
    if (!values.startJoinDate) return;
    const startJoinDate: string =
      typeof values.startJoinDate === "string" ? values.startJoinDate : "";

    onSubmit({
      ...values,
      startJoinDate,
    });
  };

  return (
    <form onSubmit={form.onSubmit(handleSubmit)}>
      <Stack gap="md">
        <TextInput
          label={t("student.nis")}
          placeholder={t("student.nisPlaceholder")}
          required
          disabled={isEdit}
          {...form.getInputProps("nis")}
        />
        <TextInput
          label={t("student.nik")}
          placeholder={t("student.nikPlaceholder")}
          required
          maxLength={16}
          {...form.getInputProps("nik")}
        />
        <TextInput
          label={t("student.name")}
          placeholder={t("student.namePlaceholder")}
          required
          {...form.getInputProps("name")}
        />
        <Textarea
          label={t("student.address")}
          placeholder={t("student.addressPlaceholder")}
          required
          {...form.getInputProps("address")}
        />
        <TextInput
          label={t("student.parentName")}
          placeholder={t("student.parentNamePlaceholder")}
          required
          {...form.getInputProps("parentName")}
        />
        <TextInput
          label={t("student.parentPhone")}
          placeholder={t("student.parentPhonePlaceholder")}
          required
          {...form.getInputProps("parentPhone")}
        />
        <DatePickerInput
          label={t("student.joinDate")}
          placeholder="DD/MM/YYYY"
          required
          valueFormat="DD/MM/YYYY"
          {...form.getInputProps("startJoinDate")}
        />
        <Button type="submit" loading={isLoading}>
          {isEdit ? t("common.update") : t("common.create")}
        </Button>
      </Stack>
    </form>
  );
}
