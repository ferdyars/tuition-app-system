generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum Role {
  ADMIN
  CASHIER
}

enum PaymentStatus {
  UNPAID
  PAID
  PARTIAL
}

enum Month {
  JULY
  AUGUST
  SEPTEMBER
  OCTOBER
  NOVEMBER
  DECEMBER
  JANUARY
  FEBRUARY
  MARCH
  APRIL
  MAY
  JUNE
}

enum PaymentFrequency {
  MONTHLY
  QUARTERLY
  SEMESTER
}

enum PaymentRequestStatus {
  PENDING
  EXPIRED
  VERIFYING
  VERIFIED
  FAILED
  CANCELLED
}

enum RecordStatus {
  ACTIVE
  INACTIVE
}

enum WhatsAppLogStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

// ============================================
// EMPLOYEE MANAGEMENT
// ============================================

model Employee {
  employeeId String   @id @default(uuid()) @map("employee_id")
  name       String
  email      String   @unique
  password   String
  role       Role     @default(CASHIER)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  payments Payment[]

  @@map("employees")
}

// ============================================
// STUDENT MANAGEMENT
// ============================================

model Student {
  nis           String   @id @map("nis")
  nik           String   @unique @map("nik")
  name          String
  address       String
  parentName    String   @map("parent_name")
  parentPhone   String   @map("parent_phone")
  startJoinDate DateTime @map("start_join_date")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // ========== Account Fields (Phase 2) ==========
  hasAccount         Boolean   @default(false) @map("has_account")
  password           String?   // Hashed (default: parent phone number)
  mustChangePassword Boolean   @default(true) @map("must_change_password")
  lastLoginAt        DateTime? @map("last_login_at")
  lastPaymentAt      DateTime? @map("last_payment_at")
  accountCreatedAt   DateTime? @map("account_created_at")
  accountCreatedBy   String?   @map("account_created_by")

  // Account Soft Delete
  accountDeleted       Boolean   @default(false) @map("account_deleted")
  accountDeletedAt     DateTime? @map("account_deleted_at")
  accountDeletedBy     String?   @map("account_deleted_by")
  accountDeletedReason String?   @map("account_deleted_reason")

  // Relations
  scholarships    Scholarship[]
  tuitions        Tuition[]
  studentClasses  StudentClass[]
  paymentRequests PaymentRequest[]

  // Indexes
  @@index([hasAccount])
  @@index([hasAccount, accountDeleted])
  @@index([lastPaymentAt])
  @@map("students")
}

// ============================================
// ACADEMIC YEAR MANAGEMENT
// ============================================

model AcademicYear {
  id        String   @id @default(uuid())
  year      String   @unique
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")
  isActive  Boolean  @default(false) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  classAcademics ClassAcademic[]
  discounts      Discount[]

  @@map("academic_years")
}

// ============================================
// CLASS MANAGEMENT
// ============================================

model ClassAcademic {
  id               String           @id @default(uuid())
  academicYearId   String           @map("academic_year_id")
  grade            Int
  section          String
  className        String           @map("class_name")
  // Payment configuration
  paymentFrequency PaymentFrequency @default(MONTHLY) @map("payment_frequency")
  monthlyFee       Decimal?         @map("monthly_fee") @db.Decimal(10, 2)
  quarterlyFee     Decimal?         @map("quarterly_fee") @db.Decimal(10, 2)
  semesterFee      Decimal?         @map("semester_fee") @db.Decimal(10, 2)
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  academicYear   AcademicYear   @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  tuitions       Tuition[]
  scholarships   Scholarship[]
  studentClasses StudentClass[]
  discounts      Discount[]

  @@unique([academicYearId, grade, section])
  @@map("class_academics")
}

// ============================================
// STUDENT-CLASS ASSIGNMENT (Junction Table)
// ============================================

model StudentClass {
  id              String   @id @default(uuid())
  studentNis      String   @map("student_nis")
  classAcademicId String   @map("class_academic_id")
  enrolledAt      DateTime @default(now()) @map("enrolled_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  student       Student       @relation(fields: [studentNis], references: [nis], onDelete: Cascade)
  classAcademic ClassAcademic @relation(fields: [classAcademicId], references: [id], onDelete: Cascade)

  @@unique([studentNis, classAcademicId])
  @@index([studentNis])
  @@index([classAcademicId])
  @@map("student_classes")
}

// ============================================
// TUITION MANAGEMENT
// ============================================

model Tuition {
  id                String        @id @default(uuid())
  classAcademicId   String        @map("class_academic_id")
  studentNis        String        @map("student_nis")
  period            String        // JULY, AUGUST, ..., Q1, Q2, Q3, Q4, SEM1, SEM2
  month             Month?        // Kept for backward compatibility (nullable)
  year              Int
  feeAmount         Decimal       @map("fee_amount") @db.Decimal(10, 2)
  scholarshipAmount Decimal       @default(0) @map("scholarship_amount") @db.Decimal(10, 2)
  discountAmount    Decimal       @default(0) @map("discount_amount") @db.Decimal(10, 2)
  discountId        String?       @map("discount_id")
  paidAmount        Decimal       @default(0) @map("paid_amount") @db.Decimal(10, 2)
  status            PaymentStatus @default(UNPAID)
  dueDate           DateTime      @map("due_date")
  generatedAt       DateTime      @default(now()) @map("generated_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  classAcademic   ClassAcademic    @relation(fields: [classAcademicId], references: [id], onDelete: Cascade)
  student         Student          @relation(fields: [studentNis], references: [nis], onDelete: Cascade)
  discount        Discount?        @relation(fields: [discountId], references: [id], onDelete: SetNull)
  payments        Payment[]
  paymentRequests PaymentRequestTuition[]

  @@unique([classAcademicId, studentNis, period, year])
  @@index([studentNis])
  @@index([classAcademicId])
  @@index([status])
  @@index([dueDate])
  @@index([period])
  @@index([discountId])
  @@map("tuitions")
}

// ============================================
// SCHOLARSHIP MANAGEMENT
// ============================================

model Scholarship {
  id                String   @id @default(uuid())
  studentNis        String   @map("student_nis")
  classAcademicId   String   @map("class_academic_id")
  name              String   @default("Scholarship") // e.g., "Academic", "Sports", "Need-based"
  nominal           Decimal  @db.Decimal(10, 2)
  isFullScholarship Boolean  @default(false) @map("is_full_scholarship")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  student       Student       @relation(fields: [studentNis], references: [nis], onDelete: Cascade)
  classAcademic ClassAcademic @relation(fields: [classAcademicId], references: [id], onDelete: Cascade)

  // Removed unique constraint to allow multiple scholarships per student per class
  @@index([studentNis])
  @@index([classAcademicId])
  @@index([studentNis, classAcademicId])
  @@map("scholarships")
}

// ============================================
// PAYMENT MANAGEMENT
// ============================================

model Payment {
  id                String   @id @default(uuid())
  tuitionId         String   @map("tuition_id")
  employeeId        String   @map("employee_id")
  amount            Decimal  @db.Decimal(10, 2)
  scholarshipAmount Decimal  @default(0) @map("scholarship_amount") @db.Decimal(10, 2)
  paymentDate       DateTime @default(now()) @map("payment_date")
  notes             String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  tuition  Tuition  @relation(fields: [tuitionId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [employeeId], onDelete: Restrict)

  @@index([tuitionId])
  @@index([employeeId])
  @@index([paymentDate])
  @@map("payments")
}

// ============================================
// DISCOUNT MANAGEMENT
// ============================================

model Discount {
  id              String   @id @default(uuid())
  name            String
  description     String?
  reason          String?  // e.g., "COVID Relief", "School Anniversary"
  discountAmount  Decimal  @map("discount_amount") @db.Decimal(10, 2)
  targetPeriods   String[] @map("target_periods") // e.g., ["JULY", "AUGUST"] or ["Q1"] or ["SEM1"]
  academicYearId  String   @map("academic_year_id")
  classAcademicId String?  @map("class_academic_id") // null = school-wide
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  academicYear  AcademicYear   @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  classAcademic ClassAcademic? @relation(fields: [classAcademicId], references: [id], onDelete: Cascade)
  tuitions      Tuition[]

  @@index([academicYearId])
  @@index([classAcademicId])
  @@index([isActive])
  @@map("discounts")
}

// ============================================
// SCHOOL BANK ACCOUNTS (Phase 2)
// ============================================

model SchoolBankAccount {
  id            String   @id @default(uuid())
  bankName      String   @map("bank_name")
  bankCode      String   @map("bank_code")
  accountNumber String   @map("account_number")
  accountName   String   @map("account_name")
  logoUrl       String?  @map("logo_url")
  displayOrder  Int      @default(0) @map("display_order")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  paymentRequests PaymentRequest[]
  bankEmailLogs   BankEmailLog[]

  @@unique([bankCode, accountNumber])
  @@index([isActive])
  @@map("school_bank_accounts")
}

// ============================================
// PAYMENT REQUEST (Phase 2)
// ============================================

model PaymentRequest {
  id             String               @id @default(uuid())
  studentNis     String               @map("student_nis")
  bankAccountId  String?              @map("bank_account_id") // Optional - set when IMAP matches
  baseAmount     Decimal              @map("base_amount") @db.Decimal(10, 2)
  uniqueCode     Int                  @map("unique_code")
  totalAmount    Decimal              @map("total_amount") @db.Decimal(10, 2)
  idempotencyKey String               @unique @map("idempotency_key")
  changeCount    Int                  @default(0) @map("change_count")
  changeHistory  Json?                @map("change_history")
  status         PaymentRequestStatus @default(PENDING)
  expiresAt      DateTime             @map("expires_at")
  verifiedAt     DateTime?            @map("verified_at")
  emailMatchId   String?              @map("email_match_id")
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")

  student     Student            @relation(fields: [studentNis], references: [nis], onDelete: Cascade)
  bankAccount SchoolBankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: Restrict)
  tuitions    PaymentRequestTuition[]

  @@index([status])
  @@index([totalAmount])
  @@index([expiresAt])
  @@index([bankAccountId, totalAmount])
  @@index([studentNis])
  @@map("payment_requests")
}

// Junction table for PaymentRequest <-> Tuition (many-to-many)
model PaymentRequestTuition {
  id               String   @id @default(uuid())
  paymentRequestId String   @map("payment_request_id")
  tuitionId        String   @map("tuition_id")
  amount           Decimal  @db.Decimal(10, 2) // Amount allocated to this tuition
  createdAt        DateTime @default(now()) @map("created_at")

  paymentRequest PaymentRequest @relation(fields: [paymentRequestId], references: [id], onDelete: Cascade)
  tuition        Tuition        @relation(fields: [tuitionId], references: [id], onDelete: Cascade)

  @@unique([paymentRequestId, tuitionId])
  @@index([paymentRequestId])
  @@index([tuitionId])
  @@map("payment_request_tuitions")
}

// ============================================
// BANK EMAIL LOG (Phase 2)
// ============================================

model BankEmailLog {
  id               String    @id @default(uuid())
  emailUid         String    @unique @map("email_uid")
  bankAccountId    String?   @map("bank_account_id")
  receivedAt       DateTime  @map("received_at")
  fromAddress      String    @map("from_address")
  subject          String
  amount           Decimal?  @db.Decimal(10, 2)
  senderName       String?   @map("sender_name")
  senderAccount    String?   @map("sender_account")
  rawContent       String?   @map("raw_content") @db.Text
  isMatched        Boolean   @default(false) @map("is_matched")
  matchedRequestId String?   @map("matched_request_id")
  processedAt      DateTime  @default(now()) @map("processed_at")

  bankAccount SchoolBankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)

  @@index([amount])
  @@index([isMatched])
  @@index([bankAccountId, amount])
  @@map("bank_email_logs")
}

// ============================================
// IDEMPOTENCY RECORDS (Phase 3)
// ============================================

model IdempotencyRecord {
  key       String       @id
  response  String       @db.Text
  expiresAt DateTime     @map("expires_at")
  status    RecordStatus @default(ACTIVE)
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  @@index([status, expiresAt])
  @@map("idempotency_records")
}

// ============================================
// RATE LIMIT RECORDS (Phase 3)
// ============================================

model RateLimitRecord {
  id          String       @id @default(uuid())
  key         String       @unique // identifier:action (e.g., "user123:payment_request")
  action      String       // Action type (payment_request, login, registration)
  identifier  String       // User ID, IP, or email
  count       Int          @default(1)
  windowStart DateTime     @map("window_start")
  expiresAt   DateTime     @map("expires_at")
  status      RecordStatus @default(ACTIVE)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  @@index([status, expiresAt])
  @@index([action, identifier, status])
  @@map("rate_limit_records")
}

// ============================================
// WHATSAPP LOG (Phase 3)
// ============================================

model WhatsAppLog {
  id           String            @id @default(uuid())
  phone        String
  messageType  String            @map("message_type") // PAYMENT_VERIFIED, REMINDER, etc.
  message      String            @db.Text
  status       WhatsAppLogStatus @default(PENDING)
  messageId    String?           @map("message_id") // WhatsApp/Fonnte message ID
  errorMessage String?           @map("error_message")
  sentAt       DateTime?         @map("sent_at")
  deliveredAt  DateTime?         @map("delivered_at")
  readAt       DateTime?         @map("read_at")
  createdAt    DateTime          @default(now()) @map("created_at")

  @@index([status])
  @@index([phone])
  @@index([messageType])
  @@map("whatsapp_logs")
}
